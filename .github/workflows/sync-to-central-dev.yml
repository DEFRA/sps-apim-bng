
name: Sync subtree → Central (develop)

on:
  push:
    branches: [ develop ]

concurrency:
  group: subtree-sync-develop
  cancel-in-progress: true

permissions:
  contents: read

env:
  CENTRAL_REPO: DEFRA/sps-apim-gateway
  CENTRAL_BRANCH: develop

  TEAM_REMOTE_NAME: sps-apim-bng
  TEAM_REPO_URL: DEFRA/sps-apim-bng
  TEAM_BRANCH: develop

  # Prefer team side on conflicts when combining histories (kept for parity)
  TEAM_WINS_ON_CONFLICT: "true"

  # Mapping (source → target). Lines are read one-by-one (spaces preserved).
  FOLDER_MAP: |
    internal/base/apis/BNGICC=internal/base/apis/bngicc
    internal/base/products/BNGICC-product=internal/base/products/bngicc-product
    internal/base/version sets/BNGICC=internal/base/version sets/bngicc
    internal/base/namedValues/BNGICC-frontend-clientid=internal/base/named values/CONSUMING-frontend-clientid
    internal/base/namedValues/BNGICC-backend-scopeid=internal/base/named values/BNGICC-backend-scopeid

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (team repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Start SSH agent & load central deploy key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.CENTRAL_SYNC_SSH_KEY }}

      - name: Prime known_hosts
        run: ssh-keyscan -H github.com >> ~/.ssh/known_hosts

      - name: Configure Git identity
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          # Important for case-only path changes across platforms
          git config --global core.ignorecase false

      - name: Clone central repo and sync multiple folders
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          TS="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          echo "=== Clone central repo ==="
          git clone --depth=50 "git@github.com:${CENTRAL_REPO}.git" central-repo
          cd central-repo

          echo "=== Checkout central branch (resilient) ==="
          # Refresh remote heads; do not assume 'develop' exists
          git fetch --no-tags origin --depth=50

          # Does origin/develop exist?
          if git ls-remote --exit-code --heads origin "${CENTRAL_BRANCH}" >/dev/null 2>&1; then
            echo "Found remote branch origin/${CENTRAL_BRANCH}. Checking out..."
            git checkout -B "${CENTRAL_BRANCH}" "origin/${CENTRAL_BRANCH}"
          else
            echo "Remote branch origin/${CENTRAL_BRANCH} not found."
            # Prefer origin/master if it exists
            if git ls-remote --exit-code --heads origin master >/dev/null 2>&1; then
              echo "Basing ${CENTRAL_BRANCH} on origin/master..."
              git checkout -B "${CENTRAL_BRANCH}" "origin/master"
            else
              # Try to base on the remote default branch (origin/HEAD -> origin/<default>)
              DEFAULT_REF="$(git symbolic-ref -q --short refs/remotes/origin/HEAD || true)"
              if [ -n "${DEFAULT_REF}" ] && git show-ref -q "${DEFAULT_REF}"; then
                echo "Basing ${CENTRAL_BRANCH} on ${DEFAULT_REF}..."
                git checkout -B "${CENTRAL_BRANCH}" "${DEFAULT_REF}"
              else
                # Last resort: create an orphan branch
                echo "No suitable remote base found. Creating orphan branch ${CENTRAL_BRANCH}..."
                git checkout --orphan "${CENTRAL_BRANCH}"
                # Ensure working tree starts clean (no files staged by default)
                git reset --hard
              fi
            fi
          fi

          echo "On central branch: $(git rev-parse --abbrev-ref HEAD)"

          echo "=== Add team remote and fetch ==="
          git remote add "${TEAM_REMOTE_NAME}" \
            "https://x-access-token:${GITHUB_TOKEN}@github.com/${TEAM_REPO_URL}.git" \
            || git remote set-url "${TEAM_REMOTE_NAME}" \
            "https://x-access-token:${GITHUB_TOKEN}@github.com/${TEAM_REPO_URL}.git"
          git fetch --no-tags "${TEAM_REMOTE_NAME}" "${TEAM_BRANCH}"

          echo "=== Prepare local snapshot of team branch ==="
          git checkout -B __team_branch__ "refs/remotes/${TEAM_REMOTE_NAME}/${TEAM_BRANCH}"

          # ---------- Diagnostics helper (space-safe) ----------
          list_first_level_under () {
            # $1 = prefix (e.g., "internal/base/version sets/")
            local prefix="$1"
            echo ">> First-level under '${prefix}' (team branch):"
            git ls-tree -r --name-only "__team_branch__" \
              | grep -F "^${prefix}" \
              | sed "s#^\(${prefix}[^/]\+\).*#\1#" \
              | LC_ALL=C sort -u \
              | sed 's/^/   - /' \
              || true
            echo ""
          }

          # ---------- Mapping/path validator (warn-only) ----------
          validate_path () {
            local p="$1"
            case "$p" in
              *"named values"*)
                echo "WARNING: Path contains 'named values' (with a space): $p"
                echo "         This is allowed, but 'namedValues' (camelCase) is recommended."
                ;;
            esac
          }

          echo "=== Team branch folder inventory (first-level roots) ==="
          list_first_level_under "internal/base/apis/"
          list_first_level_under "internal/base/products/"
          list_first_level_under "internal/base/namedValues/"
          list_first_level_under "internal/base/version sets/"
          echo "========================================================"

          CHANGES=false
          PR_BRANCH=""

          echo "=== Process mappings (space-safe, PR-branch bootstrap) ==="
          # Iterate mappings line-by-line (preserve spaces)
          while IFS= read -r mapping; do
            # sanitize CRLF and skip blanks/comments
            mapping="$(printf '%s' "$mapping" | tr -d '\r')"
            [ -n "${mapping}" ] || continue
            case "${mapping}" in \#*) continue;; esac

            # Split "SRC=TARGET" and trim whitespace defensively
            SRC="${mapping%%=*}"
            TARGET_PREFIX="${mapping#*=}"
            SRC="${SRC#"${SRC%%[![:space:]]*}"}"; SRC="${SRC%"${SRC##*[![:space:]]}"}"
            TARGET_PREFIX="${TARGET_PREFIX#"${TARGET_PREFIX%%[![:space:]]*}"}"
            TARGET_PREFIX="${TARGET_PREFIX%"${TARGET_PREFIX##*[![:space:]]}"}"

            # Warn, do not block
            validate_path "${SRC}"
            validate_path "${TARGET_PREFIX}"

            [ -n "${SRC}" ] && [ -n "${TARGET_PREFIX}" ] || continue

            echo "→ Processing subtree:"
            echo "   SRC   = '${SRC}'"
            echo "   TARGET= '${TARGET_PREFIX}'"

            # --- robust directory existence check on team branch ---
            FOUND=false
            if git cat-file -e "__team_branch__:${SRC}" 2>/dev/null; then
              FOUND=true
            else
              if git ls-tree -d "__team_branch__" -- "${SRC}" | grep -q . ; then
                FOUND=true
              fi
            fi

            if [ "${FOUND}" != "true" ]; then
              echo "   ✘ Source folder '${SRC}' not found on team branch. Skipping…"
              PARENT="$(dirname "${SRC}")"
              echo "   (team) first-level under '${PARENT}/':"
              git ls-tree -r --name-only "__team_branch__" \
                | grep -F "^${PARENT}/" \
                | sed "s#^\(${PARENT}/[^/]\+\).*#\1#" \
                | LC_ALL=C sort -u | sed 's/^/     • /' | head -n 50 || true
              continue
            fi
            echo "   ✔ Found '${SRC}/' on team branch"

            # Show a few files under SRC (diagnostic)
            echo "   Sample files under SRC on team branch:"
            git ls-tree -r --name-only "__team_branch__" \
              | grep -F "^${SRC}/" \
              | sed 's/^/     • /' | head -n 20 || true

            # Always split from the team snapshot
            git checkout "__team_branch__"
            SPLIT_SHA="$(git subtree split --prefix="${SRC}")"
            if [ -z "${SPLIT_SHA}" ]; then
              echo "   No split produced for ${SRC}. Skipping."
              git checkout "${CENTRAL_BRANCH}"
              continue
            fi

            # --- Write into a dedicated PR branch (not CENTRAL directly) ---
            if [ "${CHANGES}" = "false" ]; then
              PR_BRANCH="pr-subtree/${TEAM_REMOTE_NAME}/$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}"
              git checkout "${CENTRAL_BRANCH}"
              git checkout -b "${PR_BRANCH}"
            else
              git checkout "${PR_BRANCH}"
            fi

            echo "   Writing to branch: $(git rev-parse --abbrev-ref HEAD)"

            CUSTOM_MESSAGE="subtree: sync ${SRC} → ${TARGET_PREFIX} | Source: ${TEAM_REMOTE_NAME}/${TEAM_BRANCH} | Timestamp: ${TS}"

            # Conflict-free bootstrap of the subtree content into the target prefix
            git rm -r --cached --ignore-unmatch "${TARGET_PREFIX}" || true
            git clean -fdx -- "${TARGET_PREFIX}" || true
            git read-tree --prefix="${TARGET_PREFIX}/" -u "${SPLIT_SHA}"
            git add -A "${TARGET_PREFIX}"
            TREE=$(git write-tree)
            NEWCOMMIT=$(echo "${CUSTOM_MESSAGE}" | git commit-tree "$TREE" -p HEAD -p "${SPLIT_SHA}")
            git reset --hard "$NEWCOMMIT"

            CHANGES=true
          done <<< "${FOLDER_MAP}"

          echo "=== Push PR branch ==="
          if [ "${CHANGES}" = "false" ]; then
            echo "No mapped folders produced changes. Exiting."
            exit 0
          fi

          git push origin "${PR_BRANCH}" || {
            echo "Branch name collision, retrying…"
            PR_BRANCH="${PR_BRANCH}-$(date +%s)"
            git branch -m "${PR_BRANCH}"
            git push origin "${PR_BRANCH}"
          }

          echo "PR_BRANCH=${PR_BRANCH}" >> $GITHUB_ENV

      - name: Generate GitHub Action Summary
        run: |
          {
            echo "## Subtree Sync (develop) Summary"
            echo ""
            echo "**Central Repo:** ${CENTRAL_REPO}"
            echo "**Central Base:** ${CENTRAL_BRANCH}"
            echo "**Team Repo:** ${TEAM_REPO_URL}"
            echo "**Team Branch:** ${TEAM_BRANCH}"
            echo "**PR Branch:** ${PR_BRANCH:-Not created}"
            echo ""
            echo "### Folder Mapping"
            echo '```'
            echo "${FOLDER_MAP}"
            echo '```'
            echo ""
            echo "**Timestamp:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            echo "**Commit SHA:** ${GITHUB_SHA}"
            echo ""
            echo "✅ Sync completed. Check the PR branch in central."
          } >> $GITHUB_STEP_SUMMARY
